<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Downloader</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.3/cerulean/bootstrap.min.css" integrity="sha512-vaImhtQoaCXvevCM/UK+8ND/df0kiQWLtR65wgq0AWShEXLpWHMve0oGgU0q1gq1MbbyEuAhMMlqNmZd7s7wTQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body id="top">
    <div id="app" v-cloak>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark">
        <div class="container-fluid">
            <span href="#top" class="navbar-brand"> 
                <h3 class="mb-0"><i class="bi bi-download"></i> Video Downloader</h3>
            </span>
        </div>
    </nav>




    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-12">

                <!-- URL Input Card -->
                <div class="card mt-4 shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Video Downloader</h3>
                    </div>
                    <div class="card-body">
                        <form @submit.prevent="handleSubmit" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="urlInput" class="form-label">Video URL</label>
                                    <div class="input-group has-validation">
                                        <input 
                                            type="url" 
                                            class="form-control" 
                                            :class="{ 'is-valid': isUrlValid && url, 'is-invalid': !isUrlValid && url }"
                                            id="urlInput" 
                                            v-model="url" 
                                            @input="updateUrlValidation" 
                                            placeholder="Enter video URL" 
                                            required>
                                        <button class="btn btn-danger rounded-end-2" type="button" @click="resetForm">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                        <div class="valid-feedback" v-if="isUrlValid && url">
                                            Valid URL! Ready to go!
                                        </div>
                                        <div class="invalid-feedback" v-else-if="url">
                                            Please enter a valid video URL.
                                        </div>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input 
                                            class="form-check-input" 
                                            type="checkbox" 
                                            id="downloadPlaylist"
                                            v-model="downloadPlaylist"
                                        >
                                        <label class="form-check-label" for="downloadPlaylist">
                                            Download YouTube Playlist
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100" :disabled="!isUrlValid || isLoading">
                                    <span v-if="!isLoading">Go!</span>
                                    <span v-else>Loading...</span>
                                    <span class="spinner-border spinner-border-sm ms-2" v-if="isLoading" role="status"></span>
                                </button>
                        </form>
                    </div>
                </div>

                <!-- Format Selection Card -->
                <div class="card mt-4 shadow" id="formatCard" v-if="showFormatCard">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Download Format</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 text-center" v-if="videoInfo.thumbnail">
                            <img :src="[[ videoInfo.thumbnail ]]" alt="Video Thumbnail" class="img-fluid rounded" style="max-height: 200px;">
                        </div>
                        <h6 class="text-secondary">Available Formats for:</h6>
                        <h6>[[ videoInfo.title ]]</h6>
                        <div class="table-responsive bg-secondary rounded-2">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr class="table-secondary">
                                        <th>Format</th>
                                        <!-- <th>Type</th> -->
                                        <th>Resolution</th>
                                        <th>Size</th>
                                        <th>Download</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="format in videoInfo.formats" :key="format.format_id" class="table-secondary">
                                        <td>[[ format.ext || 'N/A' ]]</td>
                                        <!-- <td>[[ getFormatType(format.ext, format.quality) ]]</td> -->
                                        <td>[[ format.resolution || 'N/A' ]]</td>
                                        <td>[[ formatFileSize(format.filesize) ]]</td>
                                        <td>
                                            <button 
                                                class="btn btn-sm" 
                                                :class="format.format_id == 'mp3' ? 'btn-success' : 'btn-primary'"
                                                @click="downloadFormat(format.format_id)"
                                            >
                                                <i class="bi" :class="format.format_id == 'mp3' ? 'bi-music-note' : 'bi-download'"></i>
                                                [[ format.format_id == 'mp3' ? 'Download MP3' : 'Download' ]]
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="card mt-4 shadow" id="statusCard" v-if="showStatusCard">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Download Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress-container">
                            <div class="progress mb-2" style="height: 25px;">
                                <div 
                                    class="progress-bar progress-bar-striped progress-bar-animated bg-success d-flex align-items-center justify-content-center" 
                                    role="progressbar" 
                                    :style="{ width: downloadProgress.percent + '%' }"
                                    :aria-valuenow="downloadProgress.percent" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100"
                                >
                                    <span class="progress-percent fw-bold">[[ downloadProgress.percent.toFixed(1) ]]%</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-speedometer2 me-1"></i> [[ downloadProgress.speed ]]
                                    </span>
                                </div>
                                <div>
                                    <span class="badge bg-info">
                                        <i class="bi bi-clock-history me-1"></i> ETA: [[ downloadProgress.eta ]]
                                    </span>
                                </div>
                            </div>
                            <div class="alert alert-info p-2 mb-0 d-none" v-if="downloadProgress.status">
                                <i class="bi bi-info-circle me-2"></i> [[ downloadProgress.status ]]
                            </div>
                        </div>

                        <!-- Terminal Output -->
                        <div class="mt-3">
                            <h6>Terminal Output:</h6>
                            <div id="terminalOutput" class="terminal-output">
                                <div 
                                    v-for="line in downloadProgress.terminal" 
                                    :key="line.id" 
                                    class="terminal-line" 
                                    :class="'terminal-' + line.type"
                                >
                                    [[ line.message ]]
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="toast" :class="'show'" v-if="toast.show">
            <div class="toast-header" :class="'bg-' + toast.type + ' text-white'">
                <strong class="me-auto">[[ toast.title ]]</strong>
                <button type="button" class="btn-close" @click="toast.show = false" aria-label="Close"></button>
            </div>
            <div class="toast-body">[[ toast.message ]]</div>
        </div>
    </div>
</div>

<!-- Scripts doivent être en dehors de la div #app -->
<!-- Vue.js 3 CDN -->
<script src="https://unpkg.com/vue@3.4.21/dist/vue.global.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Axios pour les requêtes HTTP -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<!-- Notre application Vue -->
<script src="{{ url_for('static', filename='components/app.vue') }}" type="text/javascript"></script>
</body>
</html>